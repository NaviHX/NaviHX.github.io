<!doctype html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
      <meta content="text/html; charset=UTF-8" http-equiv="content-type"/>
      <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
      <meta name="robots" content="index, follow">
      
      
      
      
      
      
      
      
      
      
      
      
      <title>Exploring Lock-freedom</title>
      
      
      
      <meta name="title" content="Exploring Lock-freedom">
      
      
      
      <meta property="og:type" content="website">
      <meta property="og:url" content="https://refrigerator.navihx.top/posts/lock-free/">
      
      <meta property="og:site_name" content="">
      
      
      <meta property="og:title" content="Exploring Lock-freedom">
      
      
      
      <meta property="og:image" content="https:&#x2F;&#x2F;refrigerator.navihx.top&#x2F;favicon.ico">
      
      
      
      <meta property="twitter:card" content="summary_large_image">
      <meta property="twitter:url" content="https://refrigerator.navihx.top/posts/lock-free/">
      
      <meta property="twitter:title" content="Exploring Lock-freedom">
      
      
      
      <meta property="twitter:image" content="https:&#x2F;&#x2F;refrigerator.navihx.top&#x2F;favicon.ico">
      
      
      <link rel="canonical" href="https://refrigerator.navihx.top/posts/lock-free/">
      
      <link rel="shortcut icon" type="image/x-icon" href="https://refrigerator.navihx.top/favicon.ico">
      
      
      
      
      <link rel="alternate" type="application/atom+xml" title="RSS" href="https://refrigerator.navihx.top/atom.xml">
      
      
      
      <link rel="stylesheet" href="https://refrigerator.navihx.top/css/style.css"/>
      
   </head>
   <body>
      <div class="wrapper">
         <header>
            
            <nav class="navBar">
               
               
               
               <a href="/" >&#x2F;home&#x2F;</a>
               
               
               
               
               <a href="/posts" >&#x2F;posts&#x2F;</a>
               
               

               <div class="themeSwitch">
                  <button class="themeButton light" onclick="setTheme('light')" title="Light mode">â—</button>
                  <button class="themeButton dark" onclick="setTheme('dark')" title="Dark mode">â—‘</button>
               </div>
            </nav>
            

            <script>
               const setTheme = (theme) => {
                   document.documentElement.className = theme;
                   localStorage.setItem('theme', theme);
               }
               const getTheme = () => {
                   const theme = localStorage.getItem('theme');
                   theme && setTheme(theme);
               }
               getTheme()
            </script>
         </header>

         <main>
            




<h1 id="tan-suo-wu-suo">æ¢ç´¢æ— é”</h1>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">struct </span><span>Stack&lt;T&gt; {
</span><span>    </span><span style="color:#bf616a;">head</span><span>: Option&lt;Box&lt;Node&lt;T&gt;&gt;&gt;,
</span><span>}
</span><span>
</span><span style="color:#b48ead;">struct </span><span>Node&lt;T&gt; {
</span><span>    </span><span style="color:#bf616a;">val</span><span>: T,
</span><span>    </span><span style="color:#bf616a;">next</span><span>: Option&lt;Box&lt;Node&lt;T&gt;&gt;&gt;,
</span><span>}
</span><span>
</span><span style="color:#b48ead;">impl</span><span>&lt;T&gt; Stack&lt;T&gt; {
</span><span>    </span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">new</span><span>() -&gt; </span><span style="color:#b48ead;">Self </span><span>{
</span><span>        </span><span style="color:#b48ead;">Self </span><span>{ head: None }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">pop</span><span>(&amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>) -&gt; Option&lt;T&gt; {
</span><span>        </span><span style="color:#b48ead;">if let </span><span>Some(head) = </span><span style="color:#bf616a;">self</span><span>.head.</span><span style="color:#96b5b4;">take</span><span>() {
</span><span>            </span><span style="color:#bf616a;">self</span><span>.head = head.next;
</span><span>            Some(head.val)
</span><span>        } </span><span style="color:#b48ead;">else </span><span>{
</span><span>            None
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">push</span><span>(&amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">val</span><span>: T) {
</span><span>        </span><span style="color:#b48ead;">let mut</span><span> new_head = Box::new(Node { val, next: None });
</span><span>
</span><span>        new_head.next = </span><span style="color:#bf616a;">self</span><span>.head;
</span><span>        </span><span style="color:#bf616a;">self</span><span>.head = Some(new_head);
</span><span>    }
</span><span>}
</span></code></pre>
<p>å®ç°ä¸€ä¸ªåªç”¨äºå•çº¿ç¨‹çš„æ ˆæ˜¯éå¸¸å®¹æ˜“çš„ã€‚å¦‚æœæƒ³åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä½¿ç”¨è¿™ä¸ªæ ˆå®ç°ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨ä¸€ä¸ª <code>Mutex</code> ï¼Œå®ƒå¯ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­æä¾›äº’æ–¥çš„å¯å˜å¼•ç”¨ã€‚ç„¶è€Œï¼Œ <code>Rust</code> å†…éƒ¨é»˜è®¤ä½¿ç”¨çš„å®ç°ä¸º <code>pthread_mutex</code> ï¼Œæ€§èƒ½æŸå¤±æ¯”è¾ƒå¤§ã€‚å¯¹äºæ€§èƒ½æ•æ„Ÿçš„ç¯å¢ƒï¼Œæˆ‘ä»¬æ›´å€¾å‘äºä½¿ç”¨æ— é”çš„æ•°æ®ç»“æ„ã€‚ï¼ˆè™½ç„¶ä¹Ÿå­˜åœ¨ <a href="https://webkit.org/blog/6161/locking-in-webkit/">parking_log</a> è¿™ç±»åœ¨ä½ç«äº‰ç¯å¢ƒä¸‹æ€§èƒ½å°šå¯çš„é”ï¼‰</p>
<h2 id="atomic">Atomic</h2>
<p>åœ¨å°†è¿™ä¸ªæ ˆå®ç°ä¿®æ”¹ä¸ºæ— é”ç‰ˆæœ¬ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè§‚å¯Ÿä¸€ä¸‹å•çº¿ç¨‹ç¯å¢ƒä¸­çš„å®ç°ã€‚ä¸ºäº†å¼¹å‡ºæ ˆé¡¶çš„ä¸€ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬éœ€è¦å°†æ ˆé¡¶èµ‹å€¼ä¸ºå½“å‰æ ˆé¡¶çš„ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚ä¸ºäº†å‹å…¥ä¸€ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªæ–°å…ƒç´ ï¼Œå¹¶å°†æ–°å…ƒç´ çš„ <code>next</code> æŒ‡é’ˆæŒ‡å‘åŸæ ˆé¡¶ï¼Œç„¶åå°†æ ˆé¡¶èµ‹å€¼ä¸ºæ–°å…ƒç´ ã€‚ä½¿ç”¨ä¸æä¾›äº’æ–¥è®¿é—®çš„å®¹å™¨åœ¨å¤šä¸ªçº¿ç¨‹å…±äº«åŒä¸€ä¸ªæ ˆï¼Œè¿™è¿èƒŒäº† <code>Rust</code> çš„æ‰€æœ‰æƒè§„åˆ™ï¼Œå¯èƒ½ä¼šå¼•èµ· Bug ï¼šå½“ä¸€ä¸ªçº¿ç¨‹è¯»å– <code>next</code> åï¼Œé‡æ–°è®¾ç½® <code>head</code> å‰ï¼Œå¯èƒ½å·²ç»æœ‰å¦ä¸€ä¸ªçº¿ç¨‹å°† <code>head</code> å€¼è¿›è¡Œäº†ä¿®æ”¹å¹¶é‡Šæ”¾äº†å†…å­˜ï¼Œé‡æ–°èµ‹å€¼åé€ æˆäº† use after free é—®é¢˜ã€‚</p>
<p>é€ æˆè¿™ç§é”™è¯¯æœ‰ä¸¤ä¸ªåŸå› ï¼š</p>
<ul>
<li>çº¿ç¨‹è°ƒåº¦ã€‚åœ¨æ›´æ¢ <code>head</code> å€¼çš„è¿‡ç¨‹ä¸­åˆ‡æ¢åˆ°äº†å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚</li>
<li>ä¿®æ”¹æ‰©æ•£ã€‚å½“å‰çº¿ç¨‹å¯¹å€¼çš„ä¿®æ”¹å¯èƒ½è¿˜æ²¡æœ‰æ‰©æ•£åˆ°å…¶ä»–æ ¸å¿ƒçš„ç¼“å­˜ä¸­ï¼Œå…¶ä»–æ ¸å¿ƒå¯èƒ½ä¼šè¯»å–åˆ°ä»¥å‰çš„å€¼ã€‚</li>
</ul>
<p>æœ€æœ´ç´ çš„æƒ³æ³•å°±æ˜¯åœ¨é‡æ–°èµ‹å€¼å‰æ£€æŸ¥ä»¥ä¸‹ <code>head</code> æ˜¯å¦æ˜¯åŸæœ¬çš„å€¼ã€‚</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let</span><span> head = </span><span style="color:#bf616a;">self</span><span>.head;
</span><span style="color:#b48ead;">let</span><span> next = head.next;
</span><span style="color:#65737e;">// The thread may yield CPU here.
</span><span style="color:#b48ead;">if</span><span> head == </span><span style="color:#bf616a;">self</span><span>.head {
</span><span>    </span><span style="color:#bf616a;">self</span><span>.head = next;
</span><span>} </span><span style="color:#b48ead;">else </span><span>{
</span><span>    </span><span style="color:#65737e;">// Pop failed.
</span><span>}
</span></code></pre>
<p>ç„¶è€Œç®€å•çš„å¹¶ä¸æ˜¯å¥½çš„ï¼Œè¿™ç§åšæ³•ä¸èƒ½è§£å†³é—®é¢˜ï¼šåœ¨å½“å‰çº¿ç¨‹åˆ¤æ–­ <code>head</code> å€¼ä¹‹åï¼Œä»æ—§å¯èƒ½å‘ç”Ÿçº¿ç¨‹è°ƒåº¦ï¼›åŒæ—¶å¯¹ç¼“å­˜çš„ä¿®æ”¹ä¹Ÿä¸ä¸€å®šæ‰©æ•£åˆ°äº†å…¶ä»–æ ¸å¿ƒã€‚æ‰€ä»¥ï¼Œè¦æƒ³åœ¨ä¸ä½¿ç”¨é”çš„æƒ…å†µä¸‹è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè§£å†³æ–¹æ¡ˆéœ€è¦æ»¡è¶³ä¸€ä¸‹ä¸¤ä¸ªå¿…è¦æ¡ä»¶ï¼š</p>
<ul>
<li>åŸå­æ€§ã€‚æ¯”è¾ƒå’Œèµ‹å€¼ä½œä¸ºåŒä¸€ä¸ªåŸå­æŒ‡ä»¤ï¼Œå…¶é—´ä¸å¯è°ƒåº¦ã€‚</li>
<li>å†…å­˜å±éšœã€‚ä¿®æ”¹åå…¶ä»–æ ¸å¿ƒå¿…é¡»çŸ¥é“è¿™ä¸ªå€¼éœ€è¦é‡æ–°åŠ è½½è¿›å…¥åˆ°ç¼“å­˜ä¸­ã€‚</li>
</ul>
<p><a href="https://doc.rust-lang.org/nomicon/atomics.html"><code>Rust</code> çš„ <code>Atomic</code> å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç°è¿™ä¸¤ä¸ªæ¡ä»¶</a>ã€‚ä¸€ä¸ª <code>Atomic*</code> æä¾›äº† <code>compare_and_swap</code> / <code>compare_exchange</code> æ–¹æ³•ï¼Œå¯ä»¥è¿›è¡ŒåŸå­åœ°æ¯”è¾ƒå’Œæ›¿æ¢ã€‚åŒæ—¶ä½œä¸ºå‚æ•°çš„ <code>Ordering</code> æä¾›äº†ä¸å…¶ä»–å¯¹å†…å­˜æ“ä½œçš„äº‹ä»¶çš„ <code>happen before</code> å…³ç³»è¿›è¡Œäº†æŠ½è±¡ï¼ˆæ¢å¥è¯è¯´ï¼Œæä¾›äº†ç±»ä¼¼ <code>fence</code> æŒ‡ä»¤çš„åŠŸèƒ½ï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ ˆçš„å®ç°æ”¹æˆå¦‚ä¸‹è¿™ç§åˆ©ç”¨äº† <code>Atomic</code> çš„å½¢å¼ï¼š</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">use </span><span>std::ptr::{</span><span style="color:#bf616a;">self</span><span>, null_mut, NonNull};
</span><span style="color:#b48ead;">use </span><span>std::sync::atomic::AtomicPtr;
</span><span style="color:#b48ead;">use </span><span>std::sync::atomic::Ordering::{Acquire, Relaxed, Release};
</span><span>
</span><span style="color:#b48ead;">pub struct </span><span>Stack&lt;T&gt; {
</span><span>    </span><span style="color:#bf616a;">head</span><span>: AtomicPtr&lt;Node&lt;T&gt;&gt;,
</span><span>}
</span><span>
</span><span style="color:#b48ead;">struct </span><span>Node&lt;T&gt; {
</span><span>    </span><span style="color:#bf616a;">val</span><span>: T,
</span><span>    </span><span style="color:#bf616a;">next</span><span>: Option&lt;NonNull&lt;Node&lt;T&gt;&gt;&gt;,
</span><span>}
</span><span>
</span><span style="color:#b48ead;">impl</span><span>&lt;T&gt; Stack&lt;T&gt; {
</span><span>    </span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">new</span><span>() -&gt; Stack&lt;T&gt; {
</span><span>        Stack {
</span><span>            head: AtomicPtr::new(</span><span style="color:#96b5b4;">null_mut</span><span>()),
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">impl</span><span>&lt;T&gt; Stack&lt;T&gt; {
</span><span>    </span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">pop</span><span>(&amp;</span><span style="color:#bf616a;">self</span><span>) -&gt; Option&lt;T&gt; {
</span><span>        </span><span style="color:#b48ead;">loop </span><span>{
</span><span>            </span><span style="color:#b48ead;">let</span><span> head = </span><span style="color:#bf616a;">self</span><span>.head.</span><span style="color:#96b5b4;">load</span><span>(Acquire);
</span><span>
</span><span>            </span><span style="color:#b48ead;">if</span><span> head == </span><span style="color:#96b5b4;">null_mut</span><span>() {
</span><span>                </span><span style="color:#b48ead;">return </span><span>None;
</span><span>            } </span><span style="color:#b48ead;">else </span><span>{
</span><span>                </span><span style="color:#b48ead;">let</span><span> next = </span><span style="color:#b48ead;">unsafe </span><span>{ (*head).next.</span><span style="color:#96b5b4;">map</span><span>(|</span><span style="color:#bf616a;">n</span><span>| n.</span><span style="color:#96b5b4;">as_ptr</span><span>()).</span><span style="color:#96b5b4;">unwrap_or</span><span>(</span><span style="color:#96b5b4;">null_mut</span><span>()) };
</span><span>                </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">self</span><span>.head.</span><span style="color:#96b5b4;">compare_and_swap</span><span>(head, next, Release) == head {
</span><span>                    </span><span style="color:#b48ead;">return </span><span>Some(</span><span style="color:#b48ead;">unsafe </span><span>{ ptr::read(&amp;(*head).val) });
</span><span>                }
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">push</span><span>(&amp;</span><span style="color:#bf616a;">self</span><span>, </span><span style="color:#bf616a;">t</span><span>: T) {
</span><span>        </span><span style="color:#b48ead;">let</span><span> n = Box::into_raw(Box::new(Node { val: t, next: None }));
</span><span>        </span><span style="color:#b48ead;">loop </span><span>{
</span><span>            </span><span style="color:#b48ead;">let</span><span> head = </span><span style="color:#bf616a;">self</span><span>.head.</span><span style="color:#96b5b4;">load</span><span>(Relaxed);
</span><span>            </span><span style="color:#b48ead;">unsafe </span><span>{
</span><span>                (*n).next = NonNull::new(head);
</span><span>            }
</span><span>            </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">self</span><span>.head.</span><span style="color:#96b5b4;">compare_and_swap</span><span>(head, n, Release) == head {
</span><span>                </span><span style="color:#b48ead;">break</span><span>;
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre>
<p>è¿™ä¸ªå®ç°æä¾›äº†å†…éƒ¨å¯å˜æ€§ï¼Œæ‰€ä»¥ <code>push</code> å’Œ <code>pop</code> æ–¹æ³•ç°åœ¨åªéœ€è¦æ¥å—ä¸å¯å˜å¼•ç”¨ã€‚åŒæ—¶ï¼Œç”±äºåœ¨æ£€æŸ¥åˆ°åŸæœ¬çš„ <code>head</code> è¢«ä¿®æ”¹åä¼šå…ˆæ”¾å¼ƒæœ¬æ¬¡ä¿®æ”¹ï¼Œéšåé‡æ–°å°è¯•åŠ å…¥æˆ–åˆ é™¤å…ƒç´ ï¼Œæ‰€ä»¥è¿™ä¸ªç»“æ„æ˜¯ <code>Sync</code> çš„ï¼ˆå†…éƒ¨å¯å˜æ€§æ˜¯äº’æ–¥çš„ï¼‰ã€‚</p>
<h2 id="nei-cun-xie-lu">å†…å­˜æ³„éœ²</h2>
<p>å¦‚æœç¨‹åºä¸­ä½¿ç”¨äº†å¤§é‡çš„ <code>push</code> å’Œ <code>pop</code> æ“ä½œï¼Œä»¥ä¸Šçš„å®ç°ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²ï¼šå› ä¸ºæˆ‘ä»¬æ ¹æœ¬æ²¡æœ‰å›æ”¶å†…å­˜ã€‚æ³¨æ„åˆ°åœ¨ <code>pop</code> çš„å®ç°ä¸­ï¼Œä¹‹å‰åœ¨ <code>push</code> ä¸­åˆ©ç”¨ <code>Box</code> åˆ†é…çš„å†…å­˜åœ°å€ä½œä¸º <code>head</code> ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬ä¸¢å¼ƒ <code>head</code> æ—¶ï¼Œå¹¶æ²¡æœ‰å°†å…¶è½¬æ¢ä¸º <code>Box</code> ï¼Œè¿™é€ æˆäº†å†…å­˜æ³„éœ²ã€‚è¿™æ˜¯ä¸ºäº†æ­£ç¡®æ€§æœ‰æ„ä¸ºä¹‹ã€‚å‡è®¾æˆ‘ä»¬åœ¨ <code>pop</code> å®ç°ä¸­åŠ å…¥äº†é‡Šæ”¾å†…å­˜çš„ä»£ç ã€‚</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">if </span><span style="color:#bf616a;">self</span><span>.head.</span><span style="color:#96b5b4;">compare_and_swap</span><span>(head, next, Release) == head {
</span><span>    </span><span style="color:#b48ead;">let</span><span> val = Some(</span><span style="color:#b48ead;">unsafe </span><span>{ ptr::read(&amp;(*head).val) });
</span><span>    </span><span style="color:#65737e;">// Box the value and drop it.
</span><span>    </span><span style="color:#b48ead;">unsafe </span><span>{ Box::from_raw(head); }
</span><span>    </span><span style="color:#b48ead;">return</span><span> val;
</span><span>}
</span></code></pre>
<h2 id="aba-problem">ABA Problem</h2>
<p>ç°åœ¨æˆ‘ä»¬æ‹¥æœ‰ä¸€ä¸ªæ ˆ <code>A -&gt; B -&gt; C</code> ï¼Œæ¯ä¸€ä¸ªå­—æ¯è¡¨ç¤ºä¸€ä¸ªå†…å­˜åœ°å€ï¼Œç®­å¤´è¡¨ç¤ºè¯¥å†…å­˜åœ°å€çš„ <code>next</code> æŒ‡å‘çš„åœ°å€ã€‚å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶åˆ†åˆ«æ‰§è¡Œä¸‹é¢çš„æ“ä½œï¼š</p>
<ul>
<li>Thread 1 ï¼šå¼¹å‡ºä¸€ä¸ªå…ƒç´ ã€‚</li>
<li>Thread 2 : ä¸¤æ¬¡å¼¹å‡ºå…ƒç´ ï¼Œå‹å…¥ä¸€ä¸ªå…ƒç´ ã€‚</li>
</ul>
<p>æ­¤æ—¶ï¼Œ åœ¨ Thread 1 è¯»å…¥ <code>head</code> å€¼åï¼Œè°ƒåº¦ç¨‹åºè®© Thread 1 åœæ­¢ï¼ŒåŒæ—¶ Thread 2 å¼€å§‹æ‰§è¡Œã€‚æŒ‰ç…§æˆ‘ä»¬çš„å®ç°ï¼ŒThread 2 å°†ä¼šé‡Šæ”¾ A å’Œ B å¯¹åº”çš„å†…å­˜ã€‚åœ¨ <code>push</code> ä¸­ï¼ŒThread 2 ç”³è¯·äº†ä¸€ä¸ªæ–°å†…å­˜ç©ºé—´ç”¨äºå®‰æ”¾æ–°çš„å¤´éƒ¨èŠ‚ç‚¹ã€‚æ­¤æ—¶é—®é¢˜å‡ºç°ï¼šåˆ†é…å™¨æœ‰å¯èƒ½ä¼šé‡ç”¨å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ†é…å™¨åˆ†é…çš„æ–°åœ°å€å¯èƒ½ä¼šæ˜¯ A ã€‚æ­¤æ—¶ï¼Œå¦‚æœ Thread 1 å¼€å§‹æ‰§è¡Œï¼š</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let</span><span> next = </span><span style="color:#b48ead;">unsafe </span><span>{ (*head).next.</span><span style="color:#96b5b4;">map</span><span>(|</span><span style="color:#bf616a;">n</span><span>| n.</span><span style="color:#96b5b4;">as_ptr</span><span>()).</span><span style="color:#96b5b4;">unwrap_or</span><span>(</span><span style="color:#96b5b4;">null_mut</span><span>()) };
</span><span style="color:#65737e;">// Thread 1 stopped here before.
</span><span>
</span><span style="color:#65737e;">// Thread 1 pass the check, because the allocator allocates the same address for the new head.
</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">self</span><span>.head.</span><span style="color:#96b5b4;">compare_and_swap</span><span>(head, next, Release) == head {
</span><span>    </span><span style="color:#b48ead;">return </span><span>Some(</span><span style="color:#b48ead;">unsafe </span><span>{ ptr::read(&amp;(*head).val) });
</span><span>    </span><span style="color:#65737e;">// Because Thread 1 remember the previous next, which points to B, which is dangling now,
</span><span>    </span><span style="color:#65737e;">// future accesses will panic due to `use after free`! ğŸ¤¯
</span><span>}
</span></code></pre>
<p>é€ æˆè¿™ä¸ªé—®é¢˜çš„åŸå› ä¸»è¦æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>åœ¨åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œæˆ‘ä»¬æ— æ³•ä¿è¯æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨ä½¿ç”¨è¿™ä¸ªæŒ‡é’ˆï¼Œå› ä¸ºå…¶ä»–çº¿ç¨‹å¯èƒ½è®°å½•äº†å°†è¢«åˆ é™¤çš„æŒ‡é’ˆçš„å€¼ã€‚</li>
<li>å†…å­˜å¤ç”¨ã€‚</li>
</ul>
<p>æ‰€ä»¥åœ¨å®ç°äº†åƒåœ¾å›æ”¶æœºåˆ¶çš„è¯­è¨€ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚å¯¹äºè¿™ç§é—®é¢˜çš„è§£å†³æ–¹æ¡ˆçš„å…³æ³¨ç‚¹éƒ½åœ¨äºï¼šæˆ‘ä»¬ä½•æ—¶èƒ½å¤Ÿé‡Šæ”¾ä¸€ä¸ªèŠ‚ç‚¹ã€‚åœ¨ <a href="https://github.com/crossbeam-rs/crossbeam">Crossbeam</a> ä¸­ä½¿ç”¨äº† EBR æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2 id="epoch-based-reclamation">Epoch-based Reclamation</h2>
<p>å®ç°è¿™ä¸ªæœºåˆ¶éœ€è¦ï¼š</p>
<ul>
<li>ä¸€ä¸ªå…¨å±€ epoch è®¡æ•°å™¨ï¼ˆepoch æ•°å€¼åˆç†èŒƒå›´ä¸º 0-2 ï¼‰ã€‚</li>
<li>æ¯ä¸€ä¸ª epoch çš„å…¨å±€åƒåœ¾å®¹å™¨ã€‚</li>
<li>æ¯ä¸€ä¸ªçº¿ç¨‹çš„æ¿€æ´»æ ‡è®°ã€‚</li>
<li>æ¯ä¸€ä¸ªçº¿ç¨‹çš„ epoch è®¡æ•°å™¨ã€‚</li>
</ul>
<p>ä¸ä¼ ç»Ÿçš„åƒåœ¾å›æ”¶ä¸åŒçš„æ˜¯ï¼Œè¯¥æœºåˆ¶å¹¶ä¸éœ€è¦é€šè¿‡å›¾æ‰¾åˆ°é‚£äº›å®é™…ä¸å†éœ€è¦çš„åƒåœ¾ï¼Œè€Œæ˜¯é€šè¿‡ epoch æ¥å›æ”¶ï¼šéœ€è¦æ¸…ç†çš„å†…å­˜åœ¨å½“å‰ epoch çš„ä¸¤ä»£ä¹‹å‰ã€‚å…·ä½“çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<p>å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦å¯¹æ— é”ç»“æ„è¿›è¡Œæ“ä½œæ—¶ï¼Œå®ƒæ¿€æ´»è‡ªå·±çš„æ ‡è®°ï¼Œç„¶åå°†è‡ªå·±çš„è®¡æ•°å™¨æ›´æ–°è‡³ä¸å…¨å±€ç›¸åŒçš„å€¼ã€‚å¦‚æœå®ƒéœ€è¦ç§»é™¤ä¸€ä¸ªå†…å­˜åœ°å€ï¼Œå®ƒæ‰€åšçš„å¹¶ä¸æ˜¯ç›´æ¥å°†å…¶é‡Šæ”¾ï¼Œè€Œæ˜¯ <strong>æŠŠå†…å­˜æ”¾å…¥åˆ°å¯¹åº” epoch çš„åƒåœ¾å®¹å™¨å†…</strong> ã€‚æœ€åå°†æ ‡è®°æ”¹ä¸ºæœªæ¿€æ´»ã€‚</p>
<p>å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è¿›è¡Œå›æ”¶æ—¶ï¼Œéœ€è¦æ£€æŸ¥æ‰€æœ‰çš„æ¿€æ´»çº¿ç¨‹æ˜¯å¦éƒ½åœ¨å½“å‰çš„ epoch ä¸­ã€‚å¦‚æœéƒ½åœ¨å½“å‰ epoch ï¼Œé‚£ä¹ˆå°±å°†å…¨å±€è®¡æ•°å™¨åŠ ä¸€ï¼Œå¦‚æœä¿®æ”¹æˆåŠŸï¼Œå°±å¯ä»¥æ¸…ç†ä¸¤ä»£ä¹‹å‰çš„å†…å­˜ã€‚è¿™æ ·å¯ä»¥ä¿è¯æ‰€æœ‰å½“å‰æ­£åœ¨è¢«å¼•ç”¨çš„å†…å­˜éƒ½åœ¨ä¸Šä¸€ä»£ï¼Œä¸”ä¸¤ä»£ä¹‹å‰çš„å†…å­˜å·²ç»è¢«æ¸…ç†ã€‚</p>


         </main>

         <footer>
            
<p class="tagsData">

</p>

            <hr>
            <div class=footContainer>
               <div class="footLeft">
                  <p>Licensed under <a target="_blank" rel="noopener noreferrer" href="https://fr.wikipedia.org/wiki/Licence_MIT">MIT</a><br>
                     Built with <a target="_blank" rel="noopener noreferrer" href="https://www.getzola.org">Zola</a> using <a target="_blank" rel="noopener noreferrer" href="https://github.com/Speyll/anemone">anemone</a> theme &amp; <a target="_blank" rel="noopener noreferrer" href="https://github.com/Speyll/veqev">veqev</a> colors.<br>
                  </p>
               </div>
               <div class="footRight">
                  <!-- Size 46x46 -->
                  <img class="footGif noStyle" loading="lazy" src="https://i.ibb.co/XYDpfcs/foot.gif" alt="footGif">
                  <a class="metaData" target="_blank" rel="noopener noreferrer" href="https://refrigerator.navihx.top/atom.xml" title="Subscribe via RSS for updates.">RSS</a>
               </div>
            </div>
         </footer>
      </div>
   </body>
</html>
